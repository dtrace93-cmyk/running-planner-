<script>
  // Back-end endpoints
  const STRAVA_AUTH_URL =
    "https://probable-goggles-jjv4qj56xvqjh5wxv-4000.app.github.dev/auth/strava";
  const STRAVA_ACTIVITIES_URL =
    "https://probable-goggles-jjv4qj56xvqjh5wxv-4000.app.github.dev/api/strava/activities";

  // DOM elements
  const statusEl = document.getElementById("status");
  const activitiesEl = document.getElementById("activities");
  const connectBtn = document.getElementById("connect-strava");

  // ---- UI helpers ----
  function setStatus(message, variant = "info") {
    statusEl.textContent = message;
    statusEl.style.color =
      variant === "error" ? "var(--danger)" : "var(--muted)";
  }

  function setButtonState(isConnected) {
    connectBtn.textContent = isConnected ? "Reconnect Strava" : "Connect Strava";
  }

  function formatDuration(seconds) {
    if (typeof seconds !== "number") return "—";
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
  }

  // ---- Render activities from API shape ----
  // Back-end returns:
  // {
  //   id, name, distanceMiles, movingTimeSec,
  //   startDate, averageHeartrate, type, paceSecondsPerMile
  // }
  function renderActivities(data) {
    if (!Array.isArray(data) || data.length === 0) {
      activitiesEl.textContent = "No activities found from Strava.";
      activitiesEl.className = "muted";
      return;
    }

    const list = document.createElement("ul");
    list.className = "activity-list";

    data.forEach((activity) => {
      const li = document.createElement("li");
      li.className = "activity-item";

      const title = document.createElement("h3");
      title.textContent = activity.name || "Untitled activity";

      const meta = document.createElement("p");
      meta.className = "activity-meta";

      const distance =
        typeof activity.distanceMiles === "number"
          ? `Distance: ${activity.distanceMiles} miles`
          : "Distance: —";

      const duration =
        typeof activity.movingTimeSec === "number"
          ? `Time: ${formatDuration(activity.movingTimeSec)}`
          : "Time: —";

      const dateText = activity.startDate
        ? `Date: ${new Date(activity.startDate).toLocaleDateString()}`
        : "Date: —";

      meta.textContent = `${distance} • ${duration} • ${dateText}`;
      li.appendChild(title);
      li.appendChild(meta);

      const extraBits = [];
      if (activity.type) extraBits.push(activity.type);
      if (activity.paceSecondsPerMile)
        extraBits.push(`Pace: ${activity.paceSecondsPerMile}s/mi`);
      if (activity.averageHeartrate)
        extraBits.push(`HR: ${activity.averageHeartrate} bpm`);

      if (extraBits.length) {
        const extra = document.createElement("p");
        extra.className = "activity-meta";
        extra.textContent = extraBits.join(" • ");
        li.appendChild(extra);
      }

      list.appendChild(li);
    });

    activitiesEl.innerHTML = "";
    activitiesEl.appendChild(list);
  }

  // ---- Fetch logic ----
  async function fetchActivities(initialLoad = false) {
    if (initialLoad) {
      // Initial page load flow: always attempt to pull existing Strava data.
      setStatus("Checking Strava connection…");
    } else {
      setStatus("Fetching activities from Strava…");
    }

    try {
      const response = await fetch(STRAVA_ACTIVITIES_URL, { method: "GET" });

      if (!response.ok) {
        // 401 = not authenticated; anything else we treat as an error
        if (response.status === 401) {
          setButtonState(false);
          setStatus("Not connected to Strava yet.");
          activitiesEl.innerHTML = "No activities loaded yet.";
          activitiesEl.className = "muted";
          return;
        }
        throw new Error(`API responded with ${response.status}`);
      }

      const data = await response.json();
      renderActivities(data);
      setButtonState(true);
      setStatus("Activities loaded from Strava.");
    } catch (error) {
      console.error("Failed to load Strava activities", error);
      // How errors are handled: treat failures as not connected / offline-friendly
      setButtonState(false);
      setStatus("Unable to load Strava activities. Please try again.", "error");
      activitiesEl.innerHTML = "";
    }
  }

  // ---- Events ----
  connectBtn.addEventListener("click", () => {
    // Manual reconnect / first-time connect
    window.location.href = STRAVA_AUTH_URL;
  });

  document.addEventListener("DOMContentLoaded", () => {
    // On page load, try to auto-load Strava data without needing a click
    fetchActivities(true);
  });
</script>
